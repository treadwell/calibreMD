---
title: "CalibreMD"
author: "Ken Brooks"
date: "5/11/2025"
output: html_document
---

# Setup

```{r setup, include=FALSE}
source("lib-Rstudio.R")
source("lib.R")
setup_formatting()
setup_packages()

dataDir <- '/Users/kbrooks/Dropbox/Books/Calibre Travel Library'
#dataDir <- '/Users/kbrooks/Dropbox/Books/AI Travel Library'

md_db <- find_md_db(dataDir)
```

# Load data from SQLite to EAV table

```{r}
eav <- md_db %>% 
  load_eav() %>% 
  explode_text_features()
```

## Explore data
```{r}
tag_counts <- eav %>% get_tag_counts()
book_summary <- eav %>% get_book_summary()
tag_summary <- eav %>% get_tag_summary()
```

# Train model

```{r}
dataset <- prep_dataset(eav)
models <- train_models(dataset)
```

# Predict on all data

```{r}
predictions_probs <- predict_tags(models, dataset)
predictions_discrete <- threshold_predictions(predictions_probs, book_id = 900, threshold = 0.9)
top_n_labels <- get_top_n_labels(predictions_probs, book_id = 900, n = 5)
print(top_n_labels)
```

## Get full set of labels from threshold

```{r}

pred_long_all <- predictions_probs %>%
  tidyr::pivot_longer(-book_id, names_to = "tag", values_to = "prob")

```

## find tags that should be added

```{r}
pred_long_add <- pred_long_all %>%
  filter(prob > 0.8)

# Step 1: Load existing tags
book_tags <- eav %>% 
  filter(feature == "tag") %>%                 
  mutate(tag = value) %>% 
  select(id, tag) %>% 
  distinct() %>%                               
  arrange(id)   

existing_tags_df <- book_tags %>%
  distinct(id, tag) %>%
  rename(book_id = id, existing_tag = tag)

# Step 2: Remove predicted tags already present
new_tags_df <- pred_long_add %>%
  anti_join(existing_tags_df, by = c("book_id", "tag" = "existing_tag"))

# Step 3: Remove general predicted tags if a more specific one exists
# Join predictions with all existing tags for the same book
filtered_tags_df <- new_tags_df %>%
  left_join(existing_tags_df, by = "book_id") %>%
  group_by(book_id, tag) %>%
  filter(!any(stringr::str_starts(existing_tag, paste0(tag, ".")))) %>%  # keep tag only if no more specific one exists
  ungroup() %>%
  select(book_id, tag) %>%
  distinct()

# Step 4: Aggregate recommendations
recommended_tags_df <- filtered_tags_df %>%
  group_by(book_id) %>%
  summarize(recommended_tags = paste(tag, collapse = ", "), .groups = "drop")

# Step 5: Join with titles
book_titles_df <- eav %>%
  filter(feature == "title_original") %>%
  select(book_id = id, title = value) %>%
  distinct()

final_addition_recommendations <- recommended_tags_df %>%
  left_join(book_titles_df, by = "book_id") %>%
  select(book_id, title, recommended_tags)

```


## find tags that should be deleted

```{r}
book_tags_clean <- book_tags %>%
  mutate(tag = str_trim(tag)) %>%
  rename(book_id = id)

pred_long_clean <- pred_long_all %>%
  mutate(tag = str_trim(tag))

joined_tags <- book_tags_clean %>%
  inner_join(pred_long_clean, by = c("book_id", "tag"))

tags_to_remove <- joined_tags %>%
  filter(prob < 0.05) %>%  # or whatever threshold
  group_by(book_id) %>%
  summarize(tags_to_review = paste(tag, collapse = ", "), .groups = "drop")

# Step 4: Add book titles
book_titles_df <- eav %>%
  filter(feature == "title_original") %>%
  select(book_id = id, title = value) %>%
  distinct()

final_removal_recommendations <- tags_to_remove %>%
  left_join(book_titles_df, by = "book_id") %>%
  select(book_id, title, tags_to_review)

```
## given a tag, what books should it be in?

```{r}
suggest_tag_additions <- function(tag_name,
                                  predictions   = pred_long_all,
                                  existing_tags = existing_tags_df,
                                  titles        = book_titles_df,
                                  prob_min      = 0) {
    # basic validation ----------------------------------------------------
  stopifnot(
    all(c("book_id", "tag", "prob") %in% names(predictions)),
    all(c("book_id", "existing_tag") %in% names(existing_tags)),
    "prob_min must be in [0,1]" = prob_min >= 0 & prob_min <= 1
  )
  
    # ── build a regex that matches any descendant tag of tag_name ─────────
  # e.g. "Supply Chain"   →  "^Supply Chain\\."   (note the escaped dot)
  descendant_regex <- paste0("^", stringr::str_replace_all(tag_name, "[.]", "\\\\."), "\\.")

  predictions %>%
    filter(tag == tag_name,            # <-- leave it **quoted**
           prob >= prob_min) %>%
    anti_join(existing_tags,
              by = c("book_id", "tag" = "existing_tag")) %>%
    anti_join(
      existing_tags %>%
        filter(str_detect(existing_tag, descendant_regex)) %>%      # keep only the descendants
        distinct(book_id),                                          # we just need the IDs
      by = "book_id"
    ) %>% 
    left_join(titles, by = "book_id") %>%
    arrange(desc(prob)) %>% 
    select(book_id, title, tag, prob)
}

final_single_tag_additions <- suggest_tag_additions("@Ken Brooks", prob_min = 0.5)
print(final_single_tag_additions)

```

