---
title: "CalibreMD"
author: "Ken Brooks"
date: "5/11/2025"
output: html_document
---

# Setup

```{r setup, include=FALSE}
source("lib-Rstudio.R")
source("lib.R")
setup_formatting()
setup_packages()

#dataDir <- '/Users/kbrooks/Dropbox/Books/Calibre Travel Library'
dataDir <- '/Users/kbrooks/Dropbox/Books/AI Travel Library'

md_db <- find_md_db(dataDir)
```

# Load data from SQLite to EAV table

```{r}
eav <- md_db %>% 
  load_eav() %>% 
  explode_text_features()
```

## Explore data
```{r}
tag_counts <- eav %>% get_tag_counts()
book_summary <- eav %>% get_book_summary()
tag_summary <- eav %>% get_tag_summary()
```

# Train model

```{r}
dataset <- prep_dataset(eav)
models <- train_models(dataset)
```

# Predict on all data

```{r}
predictions_probs <- predict_tags(models, dataset)
predictions_discrete <- threshold_predictions(predictions_probs, book_id = 900, threshold = 0.9)
top_n_labels <- get_top_n_labels(predictions_probs, book_id = 900, n = 5)
print(top_n_labels)
```

## Get full set of labels from threshold

```{r}



pred_long_all <- get_label_probabilities(predictions_probs)

```

## find tags that should be added

```{r}
add_threshold <- 0.8

final_addition_recommendations <- get_recommended_add(eav, pred_long_all, add_threshold)
```


## find tags that should be deleted

```{r}

remove_threshold <- 0.05

final_removal_recommendations <- get_recommended_remove (eav, pred_long_all, remove_threshold)
```

## given a tag, what books should it be in?

```{r}
suggest_tag_additions <- function(tag_name,
                                  predictions   = pred_long_all,
                                  existing_tags = existing_tags_df,
                                  titles        = book_titles_df,
                                  prob_min      = 0) {
    # basic validation ----------------------------------------------------
  stopifnot(
    all(c("book_id", "tag", "prob") %in% names(predictions)),
    all(c("book_id", "existing_tag") %in% names(existing_tags)),
    "prob_min must be in [0,1]" = prob_min >= 0 & prob_min <= 1
  )
  
    # ── build a regex that matches any descendant tag of tag_name ─────────
  # e.g. "Supply Chain"   →  "^Supply Chain\\."   (note the escaped dot)
  descendant_regex <- paste0("^", stringr::str_replace_all(tag_name, "[.]", "\\\\."), "\\.")

  predictions %>%
    filter(tag == tag_name,            # <-- leave it **quoted**
           prob >= prob_min) %>%
    anti_join(existing_tags,
              by = c("book_id", "tag" = "existing_tag")) %>%
    anti_join(
      existing_tags %>%
        filter(str_detect(existing_tag, descendant_regex)) %>%      # keep only the descendants
        distinct(book_id),                                          # we just need the IDs
      by = "book_id"
    ) %>% 
    left_join(titles, by = "book_id") %>%
    arrange(desc(prob)) %>% 
    select(book_id, title, tag, prob)
}

final_single_tag_additions <- suggest_tag_additions("slut", prob_min = 0.5)
print(final_single_tag_additions)

```

